<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Marketing Demo</title>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: 50px auto; padding: 20px; }
    textarea, button { width: 100%; padding: 10px; margin: 10px 0; font-size: 14px; box-sizing: border-box; }
    textarea { height: 200px; }
    button { background: #0066cc; color: white; border: none; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .result { border-left: 3px solid #0066cc; padding: 10px; margin: 20px 0; background: #f5f5f5; }
    .hidden { display: none; }
    .muted { color: #666; font-size: 13px; }
    details { margin-top: 10px; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <h1>AI Marketing Workflow Automation</h1>
  <p class="muted">
    Paste messy marketing notes → get a structured summary, action items, a draft reply, and CRM fields.
  </p>

  <div>
    <label><strong>Marketing Content:</strong></label>
    <textarea id="inputText" placeholder="Paste meeting notes, campaign briefs, or client emails...

Example:
Client meeting with Acme Corp - Jan 8, 2026. Q1 campaign for new product launch. Target millennials on social media. Budget $50k. Need concepts by Jan 20. Contact: Sarah Chen (sarah@acme.com). Focus on Instagram and TikTok. Emphasize sustainability. Need competitor analysis."></textarea>
    <button id="runBtn" onclick="processContent()">Process with AI</button>
  </div>

  <div id="loading" class="hidden">Processing...</div>

  <div id="results" class="hidden">
    <h2>Results</h2>

    <div class="result">
      <h3>Summary</h3>
      <p id="summary"></p>
    </div>

    <div class="result">
      <h3>Action Items</h3>
      <div id="actions"></div>
    </div>

    <div class="result">
      <h3>Draft Content</h3>
      <pre id="draft"></pre>
    </div>

    <div class="result">
      <h3>CRM Data</h3>
      <div id="crm"></div>
    </div>

  </div>

  <script>
    const DEFAULT_WORKER = "https://marketing-worker.adamfehse.workers.dev";

    function withTimeout(ms) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), ms);
      return { controller, cleanup: () => clearTimeout(id) };
    }

    function tryParseJsonLoose(text) {
      // 1) Strip common fences
      let t = text.replace(/```json\s*|```/gi, "").trim();

      // 2) If there's extra text, try to extract first {...} block
      const firstBrace = t.indexOf("{");
      const lastBrace = t.lastIndexOf("}");
      if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
        t = t.slice(firstBrace, lastBrace + 1);
      }

      return JSON.parse(t);
    }

    async function callWorker(workerUrl, prompt) {
      const { controller, cleanup } = withTimeout(30000);

      const res = await fetch(workerUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: prompt }),
        signal: controller.signal
      }).finally(cleanup);

      if (!res.ok) {
        const body = await res.text().catch(() => "");
        throw new Error(`Worker request failed (${res.status}). ${body}`);
      }
      return res.json();
    }

    async function processContent() {
      const inputText = document.getElementById("inputText").value.trim();

      if (!inputText) {
        alert("Please enter content");
        return;
      }

      const runBtn = document.getElementById("runBtn");
      runBtn.disabled = true;

      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("results").classList.add("hidden");

      try {
        // 1st attempt
        const data1 = await callWorker(DEFAULT_WORKER, inputText);
        let raw1 = data1?.choices?.[0]?.message?.content || "";

        let result;
        try {
          result = tryParseJsonLoose(raw1);
        } catch (e) {
          // 2nd attempt: ask model to output ONLY valid JSON again
          const data2 = await callWorker(DEFAULT_WORKER, inputText);
          const raw2 = data2?.choices?.[0]?.message?.content || "";

          result = tryParseJsonLoose(raw2);
        }

        // Render results
        document.getElementById("summary").textContent = result.summary || "";
        document.getElementById("actions").innerHTML =
          normalizeActionItems(result.action_items)
            .map((a) => {
              return [
                "<details>",
                `<summary>• ${escapeHtml(a.item)}</summary>`,
                `<p class="muted"><strong>Why:</strong> ${escapeHtml(a.rationale)}</p>`,
                `<p class="muted"><strong>Evidence:</strong> “${escapeHtml(a.evidence)}”</p>`,
                "</details>"
              ].join("");
            })
            .join("");
        document.getElementById("draft").textContent = result.draft_content || "";

        const crm = result.crm_data || {};
        document.getElementById("crm").innerHTML = Object.entries(crm)
          .map(([k, v]) => `<p><strong>${escapeHtml(k)}:</strong> ${escapeHtml(formatValue(v))}</p>`)
          .join("");

        document.getElementById("results").classList.remove("hidden");
      } catch (error) {
        alert("Error: " + error.message);
      } finally {
        document.getElementById("loading").classList.add("hidden");
        runBtn.disabled = false;
      }
    }

    function formatValue(v) {
      if (v === null || v === undefined) return "null";
      if (Array.isArray(v)) return v.join(", ");
      return String(v);
    }

    function normalizeActionItems(items) {
      if (!Array.isArray(items)) return [];
      return items.map((item) => {
        if (typeof item === "string") {
          return { item, rationale: "Not provided", evidence: "Not provided" };
        }
        return {
          item: item?.item || "Untitled action",
          rationale: item?.rationale || "Not provided",
          evidence: item?.evidence || "Not provided"
        };
      });
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

  </script>
</body>
</html>
